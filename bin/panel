#!/bin/bash
#
# Panel using lemonbar.

HEIGHT=24
LINE_HEIGHT=2
FONT="Roboto Mono:size=8"
ICON_FONT="FontAwesome:size=11"
FIFO=/tmp/panel-fifo

. panel_colors

if [[ $(pgrep -cx panel) -gt 1 ]]; then
  printf "%s\n" "The panel is already running." >&2
  exit 1
fi

trap "trap - TERM; kill 0" INT TERM QUIT EXIT

[[ -e "$FIFO" ]] && rm "$FIFO"
mkfifo "$FIFO"

bspc config top_padding $HEIGHT

bspc control --subscribe > "$FIFO" &
xtitle -sf "T%s" -t 100 > "$FIFO" &
DATE=$(echo -e '\uf073')
CLOCK=$(echo -e '\uf017')
clock -sf "C$DATE %a %d %b  $CLOCK %H:%M:%S" -i 1 > "$FIFO" &

# alsa volume
while true;
do
    ALSA_VOLUME=$(amixer get Master | grep 'Front Left: Playback' | grep -o '...%' | sed 's/\[//' | sed 's/%//' | sed 's/ //')
    ALSA_STATE=$(amixer get Master | grep 'Front Left: Playback' | grep -o '\[on]')

    if [ $ALSA_STATE ]
    then
        if [ $ALSA_VOLUME -ge 70 ]
        then
            echo -e V'\uf028' $ALSA_VOLUME
        fi
        if [ $ALSA_VOLUME -gt 0 -a $ALSA_VOLUME -lt 70 ]
        then
            echo -e V'\uf027' $ALSA_VOLUME
        fi
        if [ $ALSA_VOLUME -eq 0 ]
        then
            echo -e V'\uf026' $ALSA_VOLUME
        fi
    else
        echo -e V'\uf026' $ALSA_VOLUME
    fi
    sleep 0.1
done > "$FIFO" &

while true;
do
    MEM_TOTAL=$(free --mebi | grep -o '[[:digit:]]*' | sed -n '1{p;q}')
    MEM_USED=$(free --mebi | grep -o '[[:digit:]]*' | sed -n '2{p;q}')
    echo -e "M\uf0ae $MEM_USED/$MEM_TOTAL Mi"
    sleep 1
done > "$FIFO" &

panel_bar < "$FIFO" | lemonbar \
    -g x"$HEIGHT" \
    -f "$FONT" \
    -f "$ICON_FONT" \
    -F "$COLOR_FOREGROUND" \
    -u "$LINE_HEIGHT" | while read line; do eval "$line"; done &

#    -B "$COLOR_BACKGROUND" \

wait
